<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/css/reset.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.css">
    <script src="https://cdn.mxpnl.com/libs/mixpanel-platform/build/mixpanel-platform.v0.latest.min.js"></script>
  </head>
  <body class="mixpanel-platform-body">
    <div id="results"></div>
    
    <script id="jql">
    /* JQL query goes here */
    function main() {
      return join(
        Events({
          from_date: "2016-01-01",
          to_date: "2016-09-19",
        }),
        People()
      )
      .filter(function(tup){
        return tup.event && tup.user;
      })
      .groupByUser(function(state, tups){
        state = state || {
          'install_only':true,
        };
        _.each(tups, function(tup){
         if(tup.event.name !== 'install'){
           state.install_only = false;
         }
         if(tup.user.properties.$ios_ifa){
           state.ios_ifa = tup.user.properties.$ios_ifa;
         }
        });
        return state;
      });
    }
    </script>
    
    <script>
    var script = $('#jql').html();
    script = $.trim(script);
    //console.log(script);
    var params = {};
    MP.api.jql(script,params).done(function(results) {
      var install_only_ids = {};
      var final_ids = [];
      _.each(results, function(result){
        if(result.value.install_only){
          install_only_ids[result.key[0]] = 1;
        }
      });
      _.each(results, function(result){
        if(result.value.ios_ifa){
          if(install_only_ids[result.value.ios_ifa]){
            final_ids.push(result.value.ios_ifa);
          }
        }
      })
      console.log(final_ids);
      console.log(final_ids.length);
    });
    </script>

  </body>
</html>
